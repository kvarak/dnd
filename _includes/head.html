<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{ page.title }}</title>
<link rel="icon" href="{{ site.baseurl }}/favicon.ico" type="image/x-icon">
<meta name="description" content="{% if page.description %}{{ page.description }}{% else %}Varlyn custom D&D rules, campaigns, and character options for tabletop RPG adventures{% endif %}">

<!-- Open Graph meta tags -->
<meta property="og:title" content="{{ page.title | default: 'Varlyn D&D Rules' }}">
<meta property="og:description" content="{% if page.description %}{{ page.description }}{% else %}Varlyn custom D&D rules, campaigns, and character options for tabletop RPG adventures{% endif %}">
<meta property="og:image" content="https://dnd.rigo.nu{{ site.baseurl }}/assets/images/og-image.jpg">
<meta property="og:url" content="https://dnd.rigo.nu{{ page.url }}">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Varlyn D&D Rules">

<!-- Twitter Card meta tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ page.title | default: 'Varlyn D&D Rules' }}">
<meta name="twitter:description" content="{% if page.description %}{{ page.description }}{% else %}Varlyn custom D&D rules, campaigns, and character options for tabletop RPG adventures{% endif %}">
<meta name="twitter:image" content="https://dnd.rigo.nu{{ site.baseurl }}/assets/images/og-image.jpg">

<!-- Image Attribution: og-image.jpg from Unsplash - https://unsplash.com/photos/brown-and-black-lantern-on-brown-wooden-table-zLETygkHMvQ -->

<!-- Structured Data for Rich Snippets -->
{% include structured-data.html %}

<!-- PWA Manifest -->
<link rel="manifest" href="{{ site.baseurl }}/manifest.json">
<meta name="theme-color" content="#8B4513">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Varlyn D&D">
<link rel="apple-touch-icon" href="{{ site.baseurl }}/assets/images/og-image.jpg">

<!-- Bootstrap 5.3.3 CSS (Self-hosted) -->
<link href="{{ site.baseurl }}/assets/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">

<!-- jQuery 3.7.1 library (Self-hosted) -->
<script src="{{ site.baseurl }}/assets/vendor/jquery/jquery-3.7.1.min.js"></script>

<!-- Bootstrap 5.3.3 JavaScript Bundle with Popper (Self-hosted) -->
<script src="{{ site.baseurl }}/assets/vendor/bootstrap/bootstrap.bundle.min.js"></script>

<!-- Font Awesome 7.2.0 (Self-hosted) -->
<link href="{{ site.baseurl }}/assets/vendor/fontawesome/fontawesome-all.min.css" rel="stylesheet">

<!-- Google Fonts: Buenard (Self-hosted) -->
<link href="{{ site.baseurl }}/assets/vendor/fonts/buenard.css" rel="stylesheet">

<!-- My style (minified for dev/prod parity) -->
<link rel="stylesheet" href="{{ site.baseurl }}/assets/css/style.min.css">

<!-- GoatCounter Analytics -->
<script data-goatcounter="https://stats.dnd.kvarak.net/count"
        async src="//stats.dnd.kvarak.net/count.js"></script>

<!-- Service Worker Registration -->
<script>
// Register service worker for offline caching and performance
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('{{ site.baseurl }}/sw.js', {
      scope: '{{ site.baseurl }}/'
    })
    .then(function(registration) {
      console.log('Service Worker registered successfully:', registration);

      // Check for updates
      registration.addEventListener('updatefound', function() {
        const newWorker = registration.installing;
        console.log('Service Worker update found');

        newWorker.addEventListener('statechange', function() {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New service worker is available, show update notification
            showUpdateNotification();
          }
        });
      });
    })
    .catch(function(error) {
      console.log('Service Worker registration failed:', error);
    });

    // Listen for service worker messages
    navigator.serviceWorker.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'CACHE_UPDATED') {
        console.log('Cache updated:', event.data);
      }
    });
  });

  // Show update notification when new service worker is available
  function showUpdateNotification() {
    const updateBanner = document.createElement('div');
    updateBanner.className = 'alert alert-info alert-dismissible fade show position-fixed';
    updateBanner.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    updateBanner.innerHTML = `
      <i class="fas fa-sync-alt me-2"></i>
      <strong>Site Updated!</strong> New content is available.
      <button class="btn btn-sm btn-outline-primary ms-2" onclick="updateServiceWorker()">
        Update Now
      </button>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(updateBanner);
  }

  // Update service worker and reload page
  window.updateServiceWorker = function() {
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({type: 'SKIP_WAITING'});
      window.location.reload();
    }
  };
}

// Network status indicator for offline capability
window.addEventListener('load', function() {
  function updateNetworkStatus() {
    const isOnline = navigator.onLine;
    const statusIndicator = document.getElementById('network-status');

    if (!statusIndicator) {
      const indicator = document.createElement('div');
      indicator.id = 'network-status';
      indicator.className = 'position-fixed bottom-0 end-0 m-3 d-none';
      indicator.style.zIndex = '9998';
      indicator.innerHTML = `
        <div class="badge bg-danger">
          <i class="fas fa-wifi-slash me-1"></i>Offline Mode
        </div>
      `;
      document.body.appendChild(indicator);
    }

    const indicator = document.getElementById('network-status');
    if (isOnline) {
      indicator.classList.add('d-none');
    } else {
      indicator.classList.remove('d-none');
    }
  }

  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);
  updateNetworkStatus(); // Initial check
});
</script>
