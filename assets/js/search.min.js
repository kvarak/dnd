let searchData=[],spellsLoaded=!1,equipmentLoaded=!1;const CACHE_DURATION=36e5,basePath=window.location.pathname.includes("/dnd/")?"/dnd":"";function getCachedData(e){try{const t=localStorage.getItem(e);if(!t)return null;const{data:s,timestamp:n}=JSON.parse(t);return Date.now()-n<36e5?s:(localStorage.removeItem(e),null)}catch(e){return null}}function setCachedData(e,t){try{localStorage.setItem(e,JSON.stringify({data:t,timestamp:Date.now()}))}catch(e){console.info("Cache storage unavailable")}}function updateSearchStatus(){const e=document.getElementById("site-search-input");if(e)if(spellsLoaded&&equipmentLoaded)e.placeholder="ðŸ” Search spells, equipment, skills...",e.classList.add("search-ready");else{const t=[];spellsLoaded||t.push("spells"),equipmentLoaded||t.push("equipment"),e.placeholder=`ðŸŽ² Loading ${t.join(" & ")}...`}}function loadSpells(){const e=getCachedData("dnd_spells");if(e)return searchData.push(...e),spellsLoaded=!0,console.log("Loaded "+e.length+" spells from cache"),void updateSearchStatus();fetch("https://docs.google.com/spreadsheets/d/1Lsmu72Ssq48d7Df2zqYDFUoHsdsOb7K1L_u1FshKJWc/pub?output=csv").then(e=>e.text()).then(e=>{const t=e.split("\n"),s=t[0].split(","),n=s.findIndex(e=>e.trim().startsWith("Name")),a=s.findIndex(e=>e.includes("Description")),o=s.findIndex(e=>e.trim().startsWith("Level")),c=s.findIndex(e=>e.trim().startsWith("School")),l=[];for(let e=1;e<t.length;e++){if(!t[e].trim())continue;const s=parseCSVLine(t[e]);if(s.length>n&&s[n]){const e=s[n].trim(),t=s[a]?s[a].substring(0,500):"",r=(s[o],s[c]||"");l.push({title:e,url:basePath+"/RulesMagic/spells.html#"+e.replace(/\s/g,""),collection:"spells",content:`${r} spell. ${t}`})}}searchData.push(...l),setCachedData("dnd_spells",l),spellsLoaded=!0,console.log("Loaded "+l.length+" spells for search (cached)"),updateSearchStatus()}).catch(e=>{console.info("Spell search unavailable (CORS). Other content searchable."),spellsLoaded=!0,updateSearchStatus()})}function loadEquipment(){const e=getCachedData("dnd_equipment");if(e)return searchData.push(...e),equipmentLoaded=!0,console.log("Loaded "+e.length+" equipment items from cache"),void updateSearchStatus();fetch("https://opensheet.elk.sh/1xUNZ5xcqvfepphKklfj4HQ3CbSyk342a3eIMTnSAKUY/1").then(e=>e.json()).then(e=>{const t=[];e.forEach(e=>{if(!e.Item)return;const s=e.Item.trim(),n=e.Description||"",a=e.Category||"",o=e.Price||"",c=e.Weight||"",l=s.replace(/[^a-zA-Z0-9\s-]/g,"").trim().toLowerCase().replace(/\s+/g,"-"),r=`${n} Category: ${a}, Price: ${o}${c&&"-"!==c?", Weight: "+c:""}`;t.push({title:s,url:basePath+"/RulesEquipment/equipment.html#"+l,collection:"equipment",content:r.substring(0,500)})}),searchData.push(...t),setCachedData("dnd_equipment",t),console.log("Loaded "+t.length+" equipment items for search (cached)"),equipmentLoaded=!0,updateSearchStatus()}).catch(e=>{console.info("Equipment search unavailable. Other content searchable."),equipmentLoaded=!0,updateSearchStatus()})}function parseCSVLine(e){const t=[];let s="",n=!1;for(let a=0;a<e.length;a++){const o=e[a];'"'===o?n=!n:","!==o||n?s+=o:(t.push(s),s="")}return t.push(s),t.map(e=>e.replace(/^"|"$/g,"").trim())}function performSearch(e){if(!e||e.length<2)return[];const t=e.toLowerCase().split(/\s+/).filter(e=>e.length>=2);if(0===t.length)return[];const s=[],n=new Set;return searchData.forEach(e=>{const a=e.title.toLowerCase(),o=e.content.toLowerCase();let c=0;const l=[];t.forEach(t=>{const s=a.includes(t),n=o.includes(t);if(s||n){c+=s?10:1;const n=extractMatchedWord(s?e.title:e.content,t);n&&!l.includes(n)&&l.push(n)}}),c>0&&!n.has(e.url)&&(n.add(e.url),s.push({...e,score:c,matchedWords:l,matchCount:l.length}))}),s.sort((e,t)=>t.score!==e.score?t.score-e.score:t.matchCount-e.matchCount).slice(0,25)}function extractMatchedWord(e,t){const s=e.toLowerCase(),n=t.toLowerCase(),a=s.indexOf(n);if(-1===a)return"";let o=a,c=a+n.length;for(;o>0&&/[\w']/.test(s[o-1]);)o--;for(;c<s.length&&/[\w']/.test(s[c]);)c++;return e.substring(o,c)}function displayResults(e){const t=document.getElementById("search-results");if(!e||0===e.length)return void(t.innerHTML='<div class="search-no-results">No results found</div>');const s=e.map(e=>{let t="";if(e.matchedWords&&e.matchedWords.length>0){const s=e.title.toLowerCase().trim(),n=e.matchedWords.filter(e=>e.toLowerCase()!==s);n.length>0&&(t=` <span class="search-result-match">(${n.join(", ")})</span>`)}return`\n    <a href="${e.url}" class="search-result-item">\n      <span class="search-result-collection">[${e.collection}]</span>\n      <span class="search-result-title">${e.title}${t}</span>\n    </a>\n  `}).join("");t.innerHTML=s}updateSearchStatus(),fetch(`${basePath}/search.json`).then(e=>e.json()).then(e=>{searchData=e,loadSpells(),loadEquipment()}).catch(e=>console.error("Search data load failed:",e)),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("site-search-input"),t=document.getElementById("search-results"),s=document.getElementById("search-container");if(!e)return;let n;e.addEventListener("input",function(e){clearTimeout(n);const s=e.target.value.trim();s.length<2?t.style.display="none":n=setTimeout(()=>{displayResults(performSearch(s)),t.style.display="block"},300)}),document.addEventListener("click",function(e){s.contains(e.target)||(t.style.display="none")}),e.addEventListener("focus",function(){e.value.length>=2&&(t.style.display="block")})});