!function(){"use strict";let e=[],t=!1,n=!1;const s=window.location.pathname.includes("/dnd/")?"/dnd":"";function o(e){try{const t=localStorage.getItem(e);if(!t)return null;const{data:n,timestamp:s}=JSON.parse(t);return Date.now()-s<36e5?n:(localStorage.removeItem(e),null)}catch(e){return null}}function c(e,t){try{localStorage.setItem(e,JSON.stringify({data:t,timestamp:Date.now()}))}catch(e){console.info("Cache storage unavailable")}}function l(){const e=document.getElementById("site-search-input");if(e)if(t&&n)e.placeholder="ðŸ” Search spells, equipment, skills...",e.classList.add("search-ready");else{const s=[];t||s.push("spells"),n||s.push("equipment"),e.placeholder=`ðŸŽ² Loading ${s.join(" & ")}...`}}function r(e){const t=[];let n="",s=!1;for(let o=0;o<e.length;o++){const c=e[o];'"'===c?s=!s:","!==c||s?n+=c:(t.push(n),n="")}return t.push(n),t.map(e=>e.replace(/^"|"$/g,"").trim())}l(),fetch(`${s}/search.json`).then(e=>e.json()).then(a=>{e=a,function(){const n=o("dnd_spells");if(n)return e.push(...n),t=!0,console.log("Loaded "+n.length+" spells from cache"),void l();fetch("https://docs.google.com/spreadsheets/d/1Lsmu72Ssq48d7Df2zqYDFUoHsdsOb7K1L_u1FshKJWc/pub?output=csv").then(e=>e.text()).then(n=>{const o=n.split("\n"),a=o[0].split(","),i=a.findIndex(e=>e.trim().startsWith("Name")),u=a.findIndex(e=>e.includes("Description")),h=a.findIndex(e=>e.trim().startsWith("Level")),d=a.findIndex(e=>e.trim().startsWith("School")),p=[];for(let e=1;e<o.length;e++){if(!o[e].trim())continue;const t=r(o[e]);if(t.length>i&&t[i]){const e=t[i].trim(),n=t[u]?t[u].substring(0,500):"",o=(t[h],t[d]||"");p.push({title:e,url:s+"/RulesMagic/spells.html#"+e.replace(/\s/g,""),collection:"spells",content:`${o} spell. ${n}`})}}e.push(...p),c("dnd_spells",p),t=!0,console.log("Loaded "+p.length+" spells for search (cached)"),l()}).catch(e=>{console.info("Spell search unavailable (CORS). Other content searchable."),t=!0,l()})}(),function(){const t=o("dnd_equipment");if(t)return e.push(...t),n=!0,console.log("Loaded "+t.length+" equipment items from cache"),void l();fetch("https://opensheet.elk.sh/1xUNZ5xcqvfepphKklfj4HQ3CbSyk342a3eIMTnSAKUY/1").then(e=>e.json()).then(t=>{const o=[];t.forEach(e=>{if(!e.Item)return;const t=e.Item.trim(),n=e.Description||"",c=e.Category||"",l=e.Price||"",r=e.Weight||"",a=t.replace(/[^a-zA-Z0-9\s-]/g,"").trim().toLowerCase().replace(/\s+/g,"-"),i=`${n} Category: ${c}, Price: ${l}${r&&"-"!==r?", Weight: "+r:""}`;o.push({title:t,url:s+"/RulesEquipment/equipment.html#"+a,collection:"equipment",content:i.substring(0,500)})}),e.push(...o),c("dnd_equipment",o),console.log("Loaded "+o.length+" equipment items for search (cached)"),n=!0,l()}).catch(e=>{console.info("Equipment search unavailable. Other content searchable."),n=!0,l()})}()}).catch(e=>console.error("Search data load failed:",e)),document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("site-search-input"),n=document.getElementById("search-results"),s=document.getElementById("search-container");if(!t)return;let o;t.addEventListener("input",function(t){clearTimeout(o);const s=t.target.value.trim();s.length<2?n.style.display="none":o=setTimeout(()=>{const t=function(t){if(!t||t.length<2)return[];const n=t.toLowerCase().split(/\s+/).filter(e=>e.length>=2);if(0===n.length)return[];const s=[],o=new Set;return e.forEach(e=>{const t=e.title.toLowerCase(),c=e.content.toLowerCase();let l=0;const r=[];n.forEach(n=>{const s=t.includes(n),o=c.includes(n);if(s||o){l+=s?10:1;const t=function(e,t){const n=e.toLowerCase(),s=t.toLowerCase(),o=n.indexOf(s);if(-1===o)return"";let c=o,l=o+s.length;for(;c>0&&/[\w']/.test(n[c-1]);)c--;for(;l<n.length&&/[\w']/.test(n[l]);)l++;return e.substring(c,l)}(s?e.title:e.content,n);t&&!r.includes(t)&&r.push(t)}}),l>0&&!o.has(e.url)&&(o.add(e.url),s.push({...e,score:l,matchedWords:r,matchCount:r.length}))}),s.sort((e,t)=>t.score!==e.score?t.score-e.score:t.matchCount-e.matchCount).slice(0,25)}(s);!function(e){const t=document.getElementById("search-results");if(!e||0===e.length)return void(t.innerHTML='<div class="search-no-results">No results found</div>');const n=e.map(e=>{let t="";if(e.matchedWords&&e.matchedWords.length>0){const n=e.title.toLowerCase().trim(),s=e.matchedWords.filter(e=>e.toLowerCase()!==n);s.length>0&&(t=` <span class="search-result-match">(${s.join(", ")})</span>`)}return`\n    <a href="${e.url}" class="search-result-item">\n      <span class="search-result-collection">[${e.collection}]</span>\n      <span class="search-result-title">${e.title}${t}</span>\n    </a>\n  `}).join("");t.innerHTML=n}(t),n.style.display="block"},300)}),document.addEventListener("click",function(e){s.contains(e.target)||(n.style.display="none")}),t.addEventListener("focus",function(){t.value.length>=2&&(n.style.display="block")})})}();